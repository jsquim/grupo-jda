<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador - Grupo JDA</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <h1>üßÆ Simulador de Pr√©stamos</h1>
                    <p class="subtitle">Grupo JDA ‚Ä¢ 10% anual ‚Ä¢ M√°x: $4,000 ‚Ä¢ Hasta 36 meses</p>
                </div>
                <a href="login.html" class="btn btn-secondary">üîê Admin</a>
            </div>
        </div>

        <div class="card">
            <div id="alert" class="alert"></div>

            <form id="formSimular">
                <div class="form-group">
                    <label>üíµ Monto del pr√©stamo *</label>
                    <input type="number" id="monto" min="100" max="4000" value="1000" required>
                    <small>Entre $100 y $4,000</small>
                </div>

                <div class="form-group">
                    <label>üìÖ Plazo en meses *</label>
                    <input type="number" id="plazo" min="1" max="36" value="12" required>
                    <small>Entre 1 y 36 meses</small>
                </div>

                <button type="submit" class="btn btn-primary">üìä Simular</button>
            </form>
        </div>

        <div id="resultados" style="display:none;">
            <div class="card">
                <h2>üìã Resumen</h2>
                
                <div class="resumen">
                    <div class="item">
                        <span>Monto:</span>
                        <strong id="rMonto">$0</strong>
                    </div>
                    <div class="item">
                        <span>Plazo:</span>
                        <strong id="rPlazo">0 meses</strong>
                    </div>
                    <div class="item">
                        <span>Cuota mensual:</span>
                        <strong id="rCuota">$0</strong>
                    </div>
                    <div class="item">
                        <span>Total a pagar:</span>
                        <strong id="rTotal">$0</strong>
                    </div>
                    <div class="item">
                        <span>Total intereses:</span>
                        <strong id="rIntereses">$0</strong>
                    </div>
                    <div class="item">
                        <span>Primera cuota:</span>
                        <strong id="rFecha">--</strong>
                    </div>
                </div>

                <div class="info-box">
                    ‚úÖ Podr√°s precancelar despu√©s de pagar <strong id="cuotasMin">0</strong> cuotas (25%)
                </div>

                <h3>üìä Tabla de Amortizaci√≥n</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Fecha</th>
                                <th>Saldo Inicial</th>
                                <th>Cuota</th>
                                <th>Inter√©s</th>
                                <th>Capital</th>
                                <th>Saldo Final</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody"></tbody>
                    </table>
                </div>

                <button class="btn btn-success" id="btnEnviar">‚úÖ Enviar a Aprobaci√≥n</button>
                <button class="btn btn-secondary" onclick="location.reload()">üîÑ Nueva Simulaci√≥n</button>
            </div>
        </div>

        <!-- Modal Socio -->
        <div id="modalSocio" class="modal">
            <div class="modal-content">
                <h3>üë§ Datos del Solicitante</h3>
                <div class="form-group">
                    <label>Nombre completo *</label>
                    <input type="text" id="nombre" required>
                </div>
                <div class="form-group">
                    <label>C√©dula *</label>
                    <input type="text" id="cedula" maxlength="10" required>
                </div>
                <button class="btn btn-success" id="btnConfirmar">‚úÖ Confirmar</button>
                <button class="btn btn-secondary" id="btnCancelar">‚ùå Cancelar</button>
            </div>
        </div>

        <div id="loading" style="display:none; text-align:center; padding:20px;">
            <div class="spinner"></div>
            <p>Procesando...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="database.js"></script>
    <script>
        let simulacion = null;

        // Simular pr√©stamo
        document.getElementById('formSimular').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const monto = parseFloat(document.getElementById('monto').value);
            const plazo = parseInt(document.getElementById('plazo').value);
            
            if (monto < 100 || monto > 4000) {
                alert('Monto debe estar entre $100 y $4,000');
                return;
            }
            
            if (plazo < 1 || plazo > 36) {
                alert('Plazo debe estar entre 1 y 36 meses');
                return;
            }
            
            // Calcular
            const tasa = CONFIG.tasaMensual;
            const cuota = monto * (tasa * Math.pow(1 + tasa, plazo)) / (Math.pow(1 + tasa, plazo) - 1);
            const total = cuota * plazo;
            const intereses = total - monto;
            
            // Generar tabla
            const tabla = [];
            let saldo = monto;
            const hoy = new Date();
            
            for (let i = 1; i <= plazo; i++) {
                const int = saldo * tasa;
                const cap = cuota - int;
                const saldoFinal = Math.max(0, saldo - cap);
                
                let fecha = new Date(hoy);
                if (i === 1) {
                    fecha.setDate(fecha.getDate() + 45);
                } else {
                    fecha.setDate(fecha.getDate() + 45);
                    fecha.setMonth(fecha.getMonth() + (i - 1));
                }
                
                tabla.push({
                    numero: i,
                    fechaPago: fecha,
                    saldoInicial: saldo,
                    cuota: cuota,
                    interes: int,
                    capital: cap,
                    saldoFinal: saldoFinal
                });
                
                saldo = saldoFinal;
            }
            
            // Guardar simulaci√≥n
            simulacion = { monto, plazo, cuota, total, intereses, tabla };
            
            // Mostrar resultados
            document.getElementById('rMonto').textContent = '$' + monto.toFixed(2);
            document.getElementById('rPlazo').textContent = plazo + ' meses';
            document.getElementById('rCuota').textContent = '$' + cuota.toFixed(2);
            document.getElementById('rTotal').textContent = '$' + total.toFixed(2);
            document.getElementById('rIntereses').textContent = '$' + intereses.toFixed(2);
            document.getElementById('rFecha').textContent = formatFecha(tabla[0].fechaPago);
            document.getElementById('cuotasMin').textContent = Math.ceil(plazo * 0.25);
            
            // Tabla
            const tbody = document.getElementById('tablaBody');
            tbody.innerHTML = '';
            tabla.forEach(f => {
                tbody.innerHTML += `
                    <tr>
                        <td>${f.numero}</td>
                        <td>${formatFecha(f.fechaPago)}</td>
                        <td>$${f.saldoInicial.toFixed(2)}</td>
                        <td>$${f.cuota.toFixed(2)}</td>
                        <td>$${f.interes.toFixed(2)}</td>
                        <td>$${f.capital.toFixed(2)}</td>
                        <td>$${f.saldoFinal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            document.getElementById('resultados').style.display = 'block';
            document.getElementById('resultados').scrollIntoView({ behavior: 'smooth' });
        });

        // Enviar a aprobaci√≥n
        document.getElementById('btnEnviar').addEventListener('click', function() {
            document.getElementById('modalSocio').style.display = 'flex';
        });

        document.getElementById('btnCancelar').addEventListener('click', function() {
            document.getElementById('modalSocio').style.display = 'none';
        });

        document.getElementById('btnConfirmar').addEventListener('click', async function() {
            const nombre = document.getElementById('nombre').value.trim();
            const cedula = document.getElementById('cedula').value.trim();
            
            if (!nombre || nombre.length < 5) {
                alert('Ingresa tu nombre completo');
                return;
            }
            
            if (cedula.length !== 10) {
                alert('C√©dula debe tener 10 d√≠gitos');
                return;
            }
            
            if (!confirm(`¬øConfirmar solicitud?\n\nNombre: ${nombre}\nC√©dula: ${cedula}\nMonto: $${simulacion.monto}`)) {
                return;
            }
            
            document.getElementById('modalSocio').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Buscar o crear socio
                const resSocio = await buscarOCrearSocio(nombre, cedula);
                if (!resSocio.success) throw new Error(resSocio.error);
                
                // Crear pr√©stamo
                const resPrestamo = await crearPrestamo({
                    socioId: resSocio.id,
                    monto: simulacion.monto,
                    plazo: simulacion.plazo,
                    cuotaMensual: simulacion.cuota,
                    totalPagar: simulacion.total,
                    totalIntereses: simulacion.intereses,
                    primeraCuota: simulacion.tabla[0].fechaPago.toISOString().split('T')[0],
                    tabla: simulacion.tabla
                });
                
                if (!resPrestamo.success) throw new Error(resPrestamo.error);
                
                alert(`‚úÖ Solicitud enviada correctamente\n\nN√∫mero: #${resPrestamo.id}\nSolicitante: ${nombre}`);
                location.reload();
                
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        function formatFecha(fecha) {
            const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            return `${fecha.getDate()} ${meses[fecha.getMonth()]} ${fecha.getFullYear()}`;
        }
    </script>
</body>
</html>
